---
title: "Default_Shiny_main"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Downloading libraries that will be used for this application:

```{r}
library(tidyverse) #for data manipulation and wrangling
library(visdat) # for graphing na values and similar tasks relating to na values
library(mice) # this library has tools to impute missing data 
library(VIM)
library(GGally) #for graphing and calculations.
library(ltm) # Used for finding correlation between dichotomous categorical variable and continuous variable using function (biserial.cor())
library(caret) # for testing and predictions
library(mltools) #provides machine learning tools
library(ggthemes) #for customized themes for ggplots
```

Loading the Dataset:

```{r}
loan <- read_csv("~/Desktop/LoanDefault_Shiny/Loan_Default.csv")
loan <- data.frame(loan, stringsAsFactors = F)
```


Exploring the dataset and conducting eda:

```{r}
str(loan) #148,670 obs. of  34 variables:
View(loan)
vis_dat(loan, warn_large_data = F) #graphing out where we can expect the most NA values

na_count <-sapply(loan, function(y) sum(length(which(is.na(y)))))
na_count <- data.frame(na_count)
na_count #---> Dataframe format to show how many NA values in each column/variable.


na_count %>% 
  filter(na_count>0) %>% 
  arrange(desc(na_count, na_count))->na_values_counter


na_values_counter["% of All Data"] = (na_values_counter["na_count"]/nrow(loan))*100
na_values_counter


# As we can can see there are several columns that contain significant amount
#of na values.  Columns ('Upfront_charges', Interest_rate_spread, rate_of_interest,
#dtir1) have na values that are more than 15% of the data. These columns will 
#most likely be dropped.

#Columns containing less than 15% na values, will most likely be imputed or dropped as 
#we conduct more analysis
```
Below are the columns that we currently have for our dataset.
Our data is currently divided into 'character' and 'num' types.
Due to the nature of some of these columns, we will convert them into Factors
```{r}
col_names <- data.frame(colnames(loan))

col_names <- rowid_to_column(col_names, "index")


data_types <- sapply(loan, class)
data_types <- data_frame(data_types)


col_names['Type'] <- data_types
data_types

```

Before converting these columns into factors, I will look to see how many unique
values are present in each column. This will enable me to find any columns
that may have significant skewness to one category

```{r}
loan %>% summarise_all(funs(n_distinct(.)))
# Since 'Age' has the most unique values (8) for our target columns, we will use this information
# to convert all columns with unique vales <=8 into factors. Or we will use another method(below)
```
Dealing with data types:

```{r}
loan %>% 
  select_if(is.character) #21
loan %>% 
  mutate_if(is.character, as.factor)->loan


loan$Status <- sapply(loan$Status, as.factor)
loan$term <- sapply(loan$term, as.factor)

summary(loan)# we can see that some of the factor columns are heavily skewed
#towards specific level(s)


#Gender --> More male/joint than female
#approv_in_adv --> more 'no pre-approval' than not. about 100k difference
#business_or_commercial --> Majority is for nob/c
#interest_only  --
#region --> majority of the applicants are from the Nort and the South
# Security_Type
# open_credit --> only 556 of the applicants have open_credit
# loan_type -- > Majority of applicants applied to type1 loan
# Credit_Worthiness --> majority of applicants have credit_worthiness of l1
# Term -- > 360    :121685 and 180    : 12981  -->  there are 26 levels to this column, not sure what to do
# Neg_ammortization --> majority of applicant neg. ammortization
# Secured by/total units--> almost entirely by Home, which are 1 unit()

str(loan)

# as we can see, all columns that we intent to transform into 'factor' are currently
#generated as 'character' type, except for term and status. We can use this information
# to convert all 'character' types into 'factors' then add 'term' and 'status' manually. 
```



We can already see that we will need to drops some of the columns even before
doing any visualization. 



Drop:
ID --> Id column is arbitrary and will not have any impact on EDA and consequent
models. All ids are unique, indicating that we do not have 'repeat' clients that
have outstanding loan with our company

Year --> May drop or may not. Although year will be a good feature to have to 
to its socioeconomic implications (how was the economy in a particular year), I 
will most likely drop this column. Although, I do think if I add additional feature(s)
on top of the year, like economic indicators, it may improve my model.

THIS IS SOMETHING FOR THE FUTURE DUE TO TIME CONSTRAINTS.
```{r}
loan <- subset(loan,select = -c(ID,year))

loan

```

```{r}
ggpairs(loan[,10:11]) # there is some correlation between interest_rate_spread and rate of interest

ggplot()+geom_boxplot(aes(x = loan$Status, y = loan$rate_of_interest))
# we can see that there not much of a correlation between clients who defaulted(1)
# and rate of interest. Same thing can be said about clients who did not default.
```

```{r}
ggplot()+geom_smooth(aes(x=loan$income, y = loan$property_value),show.legend = T)+
  xlab("Income - Monthly($)")+
  ylab("Property Value($)")+
  xlim(10000,500000)+scale_x_continuous(breaks=seq(10000, 500000, 1000000), limits=c(0, 500000))
  
```
```{r}
#biserial.cor(loan$Credit_Score, loan$Status) # There is almost 0 correlation between credit score and default.
```


What is the correlation between credit score and default rate. This is something
to consider as it seems counter intuitive.

As I conducted more analysis, it seemed appropriate to change the column of 'credit_score'
to a factor with 5 labels.
Labels are generated from Experian, one of the leading credit-reporting companies.


0--79 --> Very Poor
580-669 --> Poor
670-739 --> Fair
740-799 --> Good
799-above --> Excelent

```{r}

loan$Credit_Score<- cut(loan$Credit_Score, breaks=c(0, 579, 669, 739, 799,Inf), labels = 
                          
                                                                                  c('VPoor',
                                                                                   'Poor',
                                                                                   'Fair',
                                                                                   'Good',
                                                                                   'Excelent'))

str(loan)


ggplot()+geom_bar(aes(x = loan$Credit_Score, fill = loan$Status),position = 'dodge2')
```





DTIR AND STATUS

```{r}
ggplot()+geom_density(aes(x = loan$dtir, color = loan$Status)) 
ggplot()+geom_boxplot(aes(x = loan$Status, y = loan$dtir1))
```


Loan amount and Status
```{r}
ggplot()+geom_density(aes(x = loan$loan_amount, color = loan$Status))
```

rate of interest and status

```{r}
ggplot()+geom_density(aes(x = loan$rate_of_interest, color = loan$Status))
```

CORRELATION BETWEEN FEATURES

```{r}
ggplot()+geom_point(aes(x = loan$rate_of_interest, y = loan$Interest_rate_spread))+
  xlab("Rate of Interest")+
  ylab("Interest Rate Spread")+
  labs(title = "Rate of Interest Against Interest Rate Spread", )+
  theme(plot.title = element_text(face = "bold.italic", color = "red", size = 14))+
    theme_solarized() +
  scale_colour_solarized()
```


```{r}

sts <- boxplot.stats(loan$property_value)$stats #to get the quantiles and outliers
sts
Status = loan$Status
g <- ggplot()+geom_boxplot(aes(x = loan$Status, y = loan$property_value, fill =Status), outliers.shape = NA)+
  coord_cartesian(ylim = c(sts[2]/2,max(sts)*1.05))

g+theme_economist() +
  scale_colour_economist()
```


```{r}
#quartz()

Status <- loan$Status
ggplot()+geom_bar(aes(x = loan$Status, fill = Status))+ 
  labs(
    title = "Status",
    subtitle = "Distribution of Default Ratio",
    caption = "Data from www.kaggle.com/yasserh/loan-default-dataset",
    
    x = "Status",
    y = "Count"
  )+
  theme(plot.caption = element_text(face = "italic"))+
  theme(plot.title = element_text(lineheight= 0.9,
         color="black",
         face="bold.italic",
         family="sans",
         size=16,
         hjust=0.5))+
  theme(plot.subtitle = element_text(face = 'italic',
                                     color = "blue",
                                     size = 6,
                                     hjust = 0.9))+
 

  theme_solarized() +
  scale_colour_solarized()
  
```
```{r}
quartz()
ggplot()+geom_bar(aes(x = loan$Status, fill = loan$Credit_Score), position = 'dodge2')+
  labs(
    title = "Status & Credit Score",
    subtitle = "Credit Score and how it Impacts Default Rates",
    caption = "Data from www.kaggle.com/yasserh/loan-default-dataset",
    tag = "0-579 --> Very Poor 
    580-669 --> Poor 
    670-739 --> Fair 
    740-799 --> Good 
    799-above --> Excelent",
    x = "Status",
    y = "Count"
  )+
  theme(plot.caption = element_text(face = "italic"))+
  theme(plot.title = element_text(lineheight= 0.9,
         color="black",
         face="bold.italic",
         family="sans",
         size=16,
         hjust=0.5))+
  theme(plot.subtitle = element_text(face = 'italic',
                                     color = "blue",
                                     size = 12,
                                     hjust = 0.5))+
  theme(plot.tag = element_text(size = 8,
                                face = 'italic',
                                hjust = 0.6,
                                colour = "red"))+
    theme_solarized() +
  scale_colour_solarized()
```








                                






AT SOME POINT THESE WILL BE DROPPED
  'rate_of_interest'
    'Interest_rate_spread'
    'Upfront_charges'
    'income'
    'property_value'
    'LTV'
    'dtir1'

```{r}
# The Following columns contain NA's for 'Status 1', therefore will need to be dropped
# as to not to interfere with our model.


loan2 <- subset(loan2, select = -c(rate_of_interest, Interest_rate_spread, Upfront_charges, income, property_value, LTV, dtir1))
cor(loan2[sapply(loan2,is.numeric)])
```







SOME MODEL
```{r}

logicalmodel <- glm(loan2$Status~ loan2$Credit_Score, family = "binomial")
featurePlot(logicalmodel)

summary(logicalmodel)
ggplot()+geom_boxplot(aes(x = loan2$Credit_Score, y = loan2$Status))
View(loan2)

featurePlot(loan2[29,-31],y = loan2$Status,plot='pairs')


loan2_no_na <- drop_na(loan2) #dropped all na values (bad --> all status column becomes 0)
summary(loan2_no_na)

cor(loan2_no_na[sapply(loan2_no_na,is.numeric)]) #checking Correlation between numeric variables. 
```

